<div *ngIf="isLoaded">

  <h1 class="main-header"
      *ngIf="courseName.length > 0 && !isInIframe && !ticketIdFromParent">
    <span>{{ courseName }}</span>
  </h1>

  <div class="vertical-spacer" *ngIf="isInIframe"></div>

  <app-beginning-button [disabled]="state==='sending'"
        *ngIf="ticket.tila === undefined">
  </app-beginning-button>

  <div class="top-buttons" *ngIf="!ticketIdFromParent && ticket.tila > 0">
      <app-beginning-button [disabled]="state==='sending'">
      </app-beginning-button>

      <div class="spacer"></div>

      <button class="edit-button"
              [disabled]="state==='sending'"
          i18n="@@Muokkaa"
          mat-raised-button
          *ngIf="isEditable"
          (click)="editTicket()">
        Muokkaa
      </button>

      <button (click)="copyAsFAQ()"
          [disabled]="state==='sending'"
          i18n="@@Kopioi UKK"
          mat-raised-button
          *ngIf="(user.asema === 'opettaja' || user.asema === 'admin')"
          >
        Kopioi UKK:ksi
      </button>

      <button (click)="changeButton('archive')"
              i18n="@@Arkistoi"
              mat-raised-button
              *ngIf="ticket.arkistoitava === true && !isArchivePressed"
              [disabled]="state==='sending'"
              >
        Arkistoi
      </button>

      <button (click)="archiveTicket()"
              color="accent"
              i18n="@@Vahvista"
              mat-raised-button
              *ngIf="isArchivePressed"
              [disabled]="state==='sending'"
              >
        Vahvista
      </button>

      <div matTooltip="{{cantRemoveTicket}}" [matTooltipDisabled]="isRemovable">
        <button (click)="changeButton('remove')"
                [disabled]="!isRemovable || state==='sending'"
                i18n="@@Poista"
                mat-raised-button
                *ngIf="ticket.aloittaja.id === user.id && isRemovePressed === false"
                >
          Poista
        </button>
      </div>

      <button (click)="removeTicket()"
              color="accent"
              [disabled]="state==='sending'"
              i18n="@@Vahvista poisto"
              mat-raised-button
              *ngIf="isRemovePressed === true"
              >
        Vahvista poisto
      </button>
    </div>

  <section *ngIf="ticket.tila > 0">

  <!-------------- Kysymys ---------------------------------------------------->

    <div class="ticket-header">

      <h2 class="sub-header">{{ ticket.otsikko }}</h2>

      <div class="spacer"></div>

      <div class="user-info-block">
        <div class="text-info">
          <span class="theme-profile-name">{{ ticket.aloittaja.nimi }}</span>
          <div class="theme-label">
            <span>{{getSenderTitle(ticket.aloittaja.nimi, ticket.aloittaja.asema)}}
              -
            </span>
            <span *ngIf="isToday(ticket.aikaleima); else notToday" i18n="@@Tänään">
              Tänään
            </span>
            <ng-template #notToday>
              <span>{{ ticket.aikaleima | date: 'shortDate' }}</span>
            </ng-template>
            <span>&nbsp;{{ ticket.aikaleima | date: 'shortTime' }}</span>
          </div>
        </div>
        <img mat-card-avatar src="../../../assets/logos/UniOulu.png" alt="">
      </div>

    </div>

    <div *ngFor="let kentta of ticket.kentat">
      <p class="theme-label" >{{ kentta.otsikko }}</p>
      <p class="short-field-value">{{ kentta.arvo }}</p>
    </div>

    <p class="theme-label message-label" i18n="@@Viesti">Viesti</p>

    <app-message [messageHtml]=ticket.viesti></app-message>

    <!----- Liitteet ---->
    <app-view-attachments
        (errorMessage)="errorMessage = $event"
        [files]="ticket.liitteet"
        *ngIf="ticket.liitteet"
        [ticketID]="ticketID"
        >
    </app-view-attachments>

    <hr class="theme-divider">

  <!-------------- Keskustelu ------------------------------------------------->

  <h3 class="sub-header" i18n="@@Keskustelu">Keskustelu</h3>

  <app-comment
      [comment]="comment"
      [(editingCommentID)]="editingCommentIDParent"
      *ngFor="let comment of ticket.kommentit"
      [ticketID]="ticket.id"
      (messages)="messageFromComment($event)"
      >
  </app-comment>

    <div class="vertical-spacer"></div>

  <!-------------- Uuden kommentin tekeminen ---------------------------------->

    <app-editor [disabled]="state==='sending'"
                [(editorContent)]="commentText"
                *ngIf="!ticketIdFromParent"
                >
    </app-editor>

  </section>

  <div class="vertical-spacer" *ngIf="errorMessage.length > 0"></div>

  <app-error-card
      *ngIf="errorMessage.length > 0"
      i18n-title="@@Virhe"
      message="{{ errorMessage }}"
      [styles]="{ margin: '0' }"
      title="Virhe"
  >
  </app-error-card>

  <!-- Kun lähetetään liitetiedostoja -->
  <p class="theme-success-message"
      i18n="@@Uuden kysymyksen lähettäminen onnistui"
      *ngIf="state==='sending'">
    Uuden kysymyksen lähettäminen onnistui.
  </p>

  <section *ngIf="ticket.tila > 0">

    <div class="theme-actions" *ngIf="!ticketIdFromParent">

      <!-- Nimi sidottu muuttujaan, koska eri rooleilla on eri teksti. -->
      <button class="attach-button"
              (click)="uploadClick.next('add')"
              [disabled]="state==='sending'"
              [attr.aria-label]="attachFilesText"
              mat-raised-button="attachFilesText"
              >
        <mat-icon>attach_file</mat-icon>{{attachFilesText}}
      </button>

      <div class="action-spacer spacer"
          *ngIf="user.asema === 'opettaja' || user.asema ==='admin'; else spacerHere">
      </div>

      <mat-radio-group align="start"
          *ngIf="user.asema === 'opettaja' || user.asema ==='admin'"
          [(ngModel)]="newCommentState"
          [disabled]="state==='sending'"
          >
        <mat-radio-button [value]=4 i18n="@@Kommentti">
          Kommentti
        </mat-radio-button>
        <mat-radio-button [value]=3 i18n="@@Lisätietoa tarvitaan">
          Lisätietoa tarvitaan
        </mat-radio-button>
        <mat-radio-button [value]=5 i18n="@@Ratkaisuehdotus">
          Ratkaisuehdotus
        </mat-radio-button>
      </mat-radio-group>

      <ng-template #spacerHere>
        <div class="action-spacer spacer"></div>
      </ng-template>

      <button class="send-button"
              (click)="sendComment()"
              color="primary"
              [disabled]="commentText.length < 1 ||
                  attachmentsMessages === 'faulty' ||
                  state === 'sending'"
              i18n="@@Lähetä"
              mat-raised-button
              >
        Lähetä
      </button>

    </div>

    <app-edit-attachments
        (attachmentsMessages)="attachmentsMessages = $event"
        [uploadClicks]="uploadClick.asObservable()"
        (fileListOutput)="fileInfoList = $event"
        >
    </app-edit-attachments>

  </section>

</div>
