  <app-headline></app-headline>

  <div class="view-wrapper" *ngIf="isLoaded">

  <app-beginning-button
        [disabled]="state==='sending'"
        *ngIf="ticket.tila === undefined"
        >
  </app-beginning-button>

  <div class="top-buttons-wrapper" *ngIf="!ticketIdFromParent && ticket.tila > 0">

      <app-beginning-button
          (clicked)="showConfirm = true"
          [confirm]="form.dirty || isEditingComment"
          [disabled]="state==='sending'"
          >
      </app-beginning-button>

      <div class="spacer"></div>

      <button class="edit-button"
              [disabled]="state==='sending'"
              i18n="@@Muokkaa"
              mat-raised-button
              *ngIf="isEditable"
              (click)="editTicket()"
              >
        Muokkaa
      </button>

      <button (click)="copyAsFAQ()"
              [disabled]="state==='sending'"
              i18n="@@Kopioi UKK"
              mat-raised-button
              *ngIf="(user.asema === 'opettaja' || user.asema === 'admin')"
              >
        Kopioi UKK:ksi
      </button>

      <button (click)="changeButton('archive')"
              i18n="@@Ratkaistu"
              mat-raised-button
              *ngIf="ticket.arkistoitava === true && ticket.tila !== 6  &&
                  !isArchivePressed"
              [disabled]="state==='sending'"
              >
        Ratkaistu
      </button>

      <button class="remove-btn"
              (click)="archiveTicket(ticketID, courseid!)"
              color="accent"
              i18n="@@Vahvista"
              mat-raised-button
              *ngIf="isArchivePressed"
              [disabled]="state==='sending'"
              >
        Vahvista
      </button>

      <div  class="remove-btn"
            matTooltip="{{ cantRemoveTicket }}"
            [matTooltipDisabled]="isRemovable"
            >
        <button class="remove-btn"
                (click)="changeButton('remove')"
                [disabled]="!isRemovable || state === 'sending'"
                i18n="@@Poista"
                mat-raised-button
                *ngIf="ticket.aloittaja.id === user.id && isRemovePressed === false"
                >
          Poista
        </button>
      </div>

      <button (click)="removeTicket(ticketID, courseid!)"
              color="accent"
              [disabled]="state==='sending'"
              i18n="@@Vahvista poisto"
              mat-raised-button
              *ngIf="isRemovePressed === true"
              >
        Vahvista poisto
      </button>
    </div>

    <app-error  [confirmLeave]="true"
                *ngIf="showConfirm"
                [styles]="{ margin: '2rem 0 0 0' }"
                >
    </app-error>

  <!-------------- Kysymys ---------------------------------------------------->

  <section *ngIf="ticket.tila > 0">

    <div class="ticket-header">
      <h2 class="ticket-headline theme-subheading">{{ ticket.otsikko }}</h2>
      <div class="spacer"></div>
      <app-sender-info
          [aikaleima]="ticket.aikaleima"
          [styles]="{'margin-top': '1.5rem' }"
          [user]="ticket.aloittaja"
          >
      </app-sender-info>

    </div>

    <div *ngFor="let kentta of ticket.kentat">
      <p class="theme-label">{{ kentta.otsikko }}</p>
      <p class="short-field-value">{{ kentta.arvo }}</p>
    </div>

    <p class="theme-label message-label" i18n="@@Viesti">Viesti</p>

    <app-message [messageHtml]=ticket.viesti></app-message>

    <!----- Liitteet ---->
    <app-view-attachments
        (errorMessage)="errorMessage = $event"
        [files]="ticket.liitteet"
        *ngIf="ticket.liitteet"
        [ticketID]="ticketID"
        >
    </app-view-attachments>

    <hr class="theme-divider">

  <!-------------- Keskustelu ------------------------------------------------->

  <div class="h3-wrapper">
    <h3 class="discussion-h3 theme-subheading" i18n="@@Keskustelu">Keskustelu</h3>

    <button aria-label="Virkistä näkymä"
            (click)="fetchTicket(courseid!)"
            [disabled]="state==='sending'"
            i18n-aria-label="@@Virkistä näkymä"
            i18n-matTooltip="@@Virkistä näkymä"
            mat-icon-button
            matTooltip="Virkistä näkymä"
            matTooltipPosition="after"
            #tooltip="matTooltip"
            >
      <mat-icon>refresh</mat-icon>
    </button>
  </div>

    <app-comment
        [comment]="comment"
        [(editingCommentID)]="editingCommentIDParent"
        (messages)="listenMessagesFromComment($event)"
        *ngFor="let comment of ticket.kommentit"
        [ticketID]="ticket.id"
        [sender]="comment.lahettaja"
        >
    </app-comment>

    <div class="vertical-spacer"></div>

  </section>

  <!-------------- Uuden kommentin tekeminen ---------------------------------->

  <form [formGroup]="form" (ngSubmit)="sendComment()">

    <app-editor formControlName="message"
                *ngIf="!ticketIdFromParent && state !== 'error'"
                >
    </app-editor>
    <mat-error  i18n="@@Pakollinen kenttä."
                *ngIf="message?.errors?.['required'] && message?.touched"
                >
      Pakollinen kenttä.
    </mat-error>
    <mat-error  i18n="@@Tekstikenttään lisäämäsi kuva on liian iso. Liitä kenttään pienempi kuva tai lisää kuva liitetiedostona viestiin."
                *ngIf="message?.errors?.['maxlength']"
                >
      Tekstikenttään lisäämäsi kuva on liian iso. Liitä kenttään pienempi kuva tai lisää kuva liitetiedostona viestiin.
    </mat-error>

    <div class="vertical-spacer" *ngIf="errorMessage.length > 0"></div>

    <app-error  *ngIf="errorMessage.length > 0"
                i18n-title="@@Virhe"
                message="{{ errorMessage }}"
                [styles]="{ margin: '1rem 0 0 0' }"
                title="Virhe"
                >
    </app-error>

    <!-- Näytetään, kun lähetetään liitetiedostoja ja kommentin lisääminen onnistui. -->
    <p  class="theme-success-message"
        i18n="@@Kommentin lisääminen"
        *ngIf="state==='sending'"
        >
      Uuden kommentin lähettäminen onnistui.
    </p>

    <section *ngIf="ticket.tila > 0">

      <div class="theme-actions" *ngIf="!ticketIdFromParent">

        <!-- Nimi sidottu muuttujaan, koska eri rooleilla on eri teksti. -->
        <button [attr.aria-label]="attachFilesText"
                class="attach-button"
                (click)="uploadClick.next('add')"
                [disabled]="state==='sending'"
                mat-raised-button="attachFilesText"
                type="button"
                >
          <mat-icon>attach_file</mat-icon>{{attachFilesText}}
        </button>

        <!-- <div class="action-spacer spacer"
            *ngIf="user.asema === 'opettaja' || user.asema ==='admin'; else spacerHere">
        </div> -->

        <mat-radio-group
            align="start"
            [disabled]="state === 'sending'"
            *ngIf="user.asema === 'opettaja' || user.asema ==='admin'"
            [(ngModel)]="newCommentState"
            [ngModelOptions]="{standalone: true}"
            >
          <mat-radio-button [value]=4 i18n="@@Kommentti">
            Kommentti
          </mat-radio-button>
          <mat-radio-button [value]=3 i18n="@@Lisätietoa tarvitaan">
            Lisätietoa tarvitaan
          </mat-radio-button>
          <mat-radio-button [value]=5 i18n="@@Ratkaisuehdotus">
            Ratkaisuehdotus
          </mat-radio-button>
        </mat-radio-group>

        <!-- <ng-template #spacerHere> -->
          <div class="action-spacer spacer"></div>
        <!-- </ng-template> -->

        <button class="send-button"
                color="primary"
                [disabled]="state ==='sending'"
                i18n="@@Lähetä"
                mat-raised-button
                type="submit"
                >
          Lähetä
        </button>

      </div>

      <app-edit-attachments
          (attachmentsMessages)="attachmentsMessages = $event"
          (fileListOutput)="fileInfoList = $event"
          formControlName="attachments"
          [uploadClicks]="uploadClick.asObservable()"
          >
      </app-edit-attachments>

    </section>
  </form>

</div>
