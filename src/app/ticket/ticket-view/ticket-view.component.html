<mat-progress-bar class="theme-progress-bar"
    mode="indeterminate"
    *ngIf="!isLoaded">
</mat-progress-bar>

<div *ngIf="isLoaded">

  <h1 class="main-header"
      *ngIf="courseName.length > 0 && !isInIframe && !ticketIdFromParent">
    <span>{{ courseName }}</span>
  </h1>

  <div class="vertical-spacer" *ngIf="isInIframe"></div>

  <app-to-beginning-button [disabled]="state==='sending'"
        *ngIf="ticket.tila === undefined" >
  </app-to-beginning-button>

    <div class="top-buttons" *ngIf="!ticketIdFromParent && ticket.tila > 0">
      <app-to-beginning-button [disabled]="state==='sending'">
      </app-to-beginning-button>

      <div class="spacer"></div>

      <button [disabled]="state==='sending'"
          i18n="@@Muokkaa"
          mat-raised-button
          *ngIf="isEditable"
          (click)="editTicket()">
        Muokkaa
      </button>

      <button (click)="copyAsFAQ()"
          [disabled]="state==='sending'"
          i18n="@@Kopioi UKK"
          mat-raised-button
          *ngIf="(userRole === 'opettaja' || userRole === 'admin')"
          >
        Kopioi UKK:ksi
      </button>

      <div matTooltip="{{cantRemoveTicket}}"
          [matTooltipDisabled]="isRemovable">
        <button [disabled]="!isRemovable || state==='sending'"
            i18n="@@Poista" (click)="changeRemoveButton()"
            mat-raised-button
            *ngIf="ticket.aloittaja.id === user.id && isRemovePressed === false"
            >
          Poista
        </button>
      </div>

      <button (click)="removeTicket()"
          mat-raised-button
          *ngIf="isRemovePressed === true" color="accent" i18n="@@Vahvista poisto"
          [disabled]="state==='sending'">
        Vahvista poisto
      </button>
    </div>

  <section *ngIf="ticket.tila > 0">

  <!-------------- Kysymys ---------------------------------------------------->

    <div class="ticket-header">

      <h2 class="sub-header">{{ ticket.otsikko }}</h2>

      <div class="spacer"></div>

      <div class="user-info-block">
        <div class="text-info">
          <span class="theme-profile-name">{{ ticket.aloittaja.nimi }}</span>
          <div class="theme-label">
            <span>{{getSenderTitle(ticket.aloittaja.nimi, ticket.aloittaja.asema)}}
              -
            </span>
            <span *ngIf="isToday(ticket.aikaleima); else notToday" i18n="@@Tänään">
              Tänään
            </span>
            <ng-template #notToday>
              <span>{{ ticket.aikaleima | date: 'shortDate' }}</span>
            </ng-template>
            <span>&nbsp;{{ ticket.aikaleima | date: 'shortTime' }}</span>
          </div>
        </div>
        <img mat-card-avatar src="../../../assets/logos/UniOulu.png" alt="">
      </div>

    </div>

    <div *ngFor="let kentta of ticket.kentat">
      <p class="theme-label" >{{ kentta.otsikko }}</p>
      <p class="short-field-value">{{ kentta.arvo }}</p>
    </div>

    <p class="theme-label message-label" i18n="@@Viesti">Viesti</p>

    <app-message [messageHtml]=ticket.viesti></app-message>

    <!----- Liitteet ---->
    <app-view-attachments (errorMessage)="errorMessage = $event"
        [files]="ticket.liitteet"
        *ngIf="ticket.liitteet"
        [ticketID]="ticketID"
    >
    </app-view-attachments>

    <hr class="theme-divider">

  <!-------------- Keskustelu ------------------------------------------------->

  <h3 class="sub-header" i18n="@@Keskustelu">Keskustelu</h3>

    <mat-card appearance="outlined" class="answer"
        *ngFor="let comment of ticket.kommentit">

      <mat-card-header>

        <img  alt=''
              mat-card-avatar
              src="../../../assets/logos/UniOulu.png"
        >
        <mat-card-title class="theme-profile-name">
          {{ comment.lahettaja.nimi }}
        </mat-card-title>

        <mat-card-subtitle class="theme-label">
          <span>{{getSenderTitle(comment.lahettaja.nimi, comment.lahettaja.asema)}}
            -
          </span>
          <span i18n="@@Tänään" *ngIf="isToday(comment.aikaleima)" >
            Tänään
          </span>
          <span *ngIf="!isToday(comment.aikaleima)">
            {{ comment.aikaleima | date: 'shortDate' }}
          </span>
          {{ comment.aikaleima | date: 'shortTime' }}
        </mat-card-subtitle>

        <div class="spacer"></div>
        <span class="ticket-state" *ngIf="comment.tila === 5">
          {{proposedSolution}}
        </span>

        <!-- Kommentin muokkaaminen -->
        <button (click)="editComment(comment.id)"
                aria-label="Muokkaa kommenttia"
                i18n-aria-label="@@Muokkaa kommenttia"
                mat-icon-button
                *ngIf="(comment.lahettaja.id === user?.id) &&
                    (editingComment !== comment.id)"
                >
          <mat-icon>edit</mat-icon>
        </button>

      </mat-card-header>

      <mat-card-content>
        <app-message [messageHtml]=comment.viesti
          *ngIf="editingComment !== comment.id; else commentEditing"></app-message>
        <app-view-attachments (errorMessage)="errorMessage = $event"
            [files]="comment.liitteet"
            *ngIf="comment.liitteet"
            [ticketID]="ticketID"
        >
        </app-view-attachments>
      </mat-card-content>

      <ng-template #commentEditing>
        <app-editor [disabled]="state==='sending'"
            [(editorContent)]="comment.viesti"
            *ngIf="!ticketIdFromParent && editingComment === comment.id"
        >
        </app-editor>
        <div class="theme-actions">
          <div class="spacer"></div>
          <button class="send-button"
                  (click)="cancelCommentEditing()"
                  i18n="@@Peru"
                  mat-raised-button
                  >
          Peru
        </button>
          <button class="send-button"
                  (click)="sendEditedComment(comment.id, comment.viesti)"
                  color="primary"
                  mat-raised-button
          >
            OK
          </button>
        </div>
      </ng-template>

    </mat-card>

    <div class="vertical-spacer"></div>

  <!-------------- Uuden kommentin tekeminen ---------------------------------->

    <app-editor [disabled]="state==='sending'"
                [(editorContent)]="commentText"
                *ngIf="!ticketIdFromParent"
                >
    </app-editor>

  </section>

  <div class="vertical-spacer" *ngIf="errorMessage.length > 0"></div>

  <app-error-card
      *ngIf="errorMessage.length > 0"
      i18n-title="@@Virhe"
      message="{{ errorMessage }}"
      [styles]="{ margin: '0' }"
      title="Virhe"
  >
  </app-error-card>

  <!-- Kun lähetetään liitetiedostoja -->
  <p class="theme-success-message"
      i18n="@@Uuden kysymyksen lähettäminen onnistui"
      *ngIf="state==='sending'">
    Uuden kysymyksen lähettäminen onnistui.
  </p>

  <section *ngIf="ticket.tila > 0">

    <div class="theme-actions" *ngIf="!ticketIdFromParent">

      <!-- Nimi sidottu muuttujaan, koska eri rooleilla on eri teksti. -->
      <button class="attach-button"
              (click)="uploadClick.next('add')"
              [disabled]="state==='sending'"
              [attr.aria-label]="attachFilesText"
              mat-raised-button="attachFilesText"
              >
        <mat-icon>attach_file</mat-icon>{{attachFilesText}}
      </button>

      <div class="spacer"
          *ngIf="userRole === 'opettaja' || userRole ==='admin'; else spacerHere">
      </div>

      <mat-radio-group align="start"
          *ngIf="userRole === 'opettaja' || userRole ==='admin'"
          [(ngModel)]="newCommentState"
          [disabled]="state==='sending'"
          >
        <mat-radio-button [value]=4 i18n="@@Kommentti">
          Kommentti
        </mat-radio-button>
        <mat-radio-button [value]=3 i18n="@@Lisätietoa tarvitaan">
          Lisätietoa tarvitaan
        </mat-radio-button>
        <mat-radio-button [value]=5 i18n="@@Ratkaisuehdotus">
          Ratkaisuehdotus
        </mat-radio-button>
      </mat-radio-group>

      <ng-template #spacerHere><div class="spacer"></div></ng-template>

      <button class="send-button"
              (click)="sendComment()"
              color="primary"
              [disabled]="commentText.length < 1 ||
                  attachmentsMessages === 'faulty' ||
                  state === 'sending'"
              i18n="@@Lähetä"
              mat-raised-button
              >
        Lähetä
      </button>

    </div>

    <app-edit-attachments (attachmentsMessages)="attachmentsMessages = $event"
        [uploadClicks]="uploadClick.asObservable()"
        (fileListOutput)="fileInfoList = $event"
        >
    </app-edit-attachments>

  </section>

</div>
